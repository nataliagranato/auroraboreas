name: Update Homebrew Tap

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'homebrew-tap-README.md'
      - '.github/workflows/update-homebrew-tap.yml'

jobs:
  update-homebrew-tap:
    runs-on: ubuntu-latest
    name: Update Homebrew Tap Repository
    
    steps:
    - name: Checkout main repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config --global user.name "nataliagranato"
        git config --global user.email "nataliagranato@ufmg.br"
        git config --global credential.helper store

    - name: Clone homebrew-tap repository
      run: |
        set -Eeuo pipefail
        echo "ðŸº Cloning homebrew-tap repository..."
        git clone "https://x-access-token:${{ secrets.USER_TOKEN }}@github.com/nataliagranato/homebrew-tap.git" "homebrew-tap-work"
        cd "homebrew-tap-work"
      run: |
        cd homebrew-tap-work
        
        echo "ðŸ“ Creating Formula directory..."
        mkdir -p Formula
        
        echo "ðŸ“ Updating README.md..."
        if [ -f "../homebrew-tap-README.md" ]; then
          cp ../homebrew-tap-README.md README.md
          echo "âœ… README updated from homebrew-tap-README.md"
        else
          echo "âš ï¸ homebrew-tap-README.md not found, keeping existing README"
        fi
        
        echo "ðŸº Creating/updating auroraboreas formula..."
        cat > Formula/auroraboreas.rb << 'EOF'
        # This file is auto-generated by GoReleaser
        # Do not edit manually
        class Auroraboreas < Formula
          desc "Aurora Boreas - Poesia e visualizaÃ§Ã£o de cÃ©u estrelado"
          homepage "https://github.com/nataliagranato/auroraboreas"
          version "0.1.0"
          
          # This will be updated by GoReleaser
          url "https://github.com/nataliagranato/auroraboreas/releases/download/v0.1.0/auroraboreas-v0.1.0-darwin-amd64.tar.gz"
          sha256 "placeholder"
          
          def install
            bin.install "aurora"
          end

          test do
            system "#{bin}/aurora", "--version"
          end
        end
        EOF
        
        echo "ðŸ“„ Creating .gitignore if needed..."
        if [ ! -f ".gitignore" ]; then
          cat > .gitignore << 'EOF'
        .DS_Store
        *.swp
        *.swo
        *~
        EOF
        fi

    - name: Commit and push changes
      env:
        USER_TOKEN: ${{ secrets.USER_TOKEN }}
      run: |
        cd homebrew-tap-work
        
        echo "ðŸ” Checking for changes..."
        git add .
        
        if git diff --staged --quiet; then
          echo "âœ… No changes to commit"
        else
          echo "ðŸ“¤ Committing changes..."
          git commit -m "Update Aurora Boreas Homebrew tap via GitHub Actions

        - Update Formula structure
        - Update README with latest information
        - Ensure all required files are present
        - Formula will be auto-updated by GoReleaser on releases
        
        Triggered by: ${{ github.event_name }}
        Commit: ${{ github.sha }}
        Actor: ${{ github.actor }}"
          
          echo "ðŸ“¤ Pushing to homebrew-tap repository..."
          git push origin main
          
          echo "âœ… Successfully updated homebrew-tap repository!"
        fi

    - name: Summary
      run: |
        echo "## ðŸº Homebrew Tap Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Repository Updated" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository**: [nataliagranato/homebrew-tap](https://github.com/nataliagranato/homebrew-tap)" >> $GITHUB_STEP_SUMMARY
        echo "- **Formula**: [auroraboreas.rb](https://github.com/nataliagranato/homebrew-tap/blob/main/Formula/auroraboreas.rb)" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Actor**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
        echo "1. Create a new release to trigger GoReleaser" >> $GITHUB_STEP_SUMMARY
        echo "2. GoReleaser will automatically update the formula with correct URLs and checksums" >> $GITHUB_STEP_SUMMARY
        echo "3. Test installation: \`brew tap nataliagranato/tap && brew install auroraboreas\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
        echo "- [Create New Release](https://github.com/nataliagranato/auroraboreas/releases/new)" >> $GITHUB_STEP_SUMMARY
        echo "- [View Homebrew Tap](https://github.com/nataliagranato/homebrew-tap)" >> $GITHUB_STEP_SUMMARY
        echo "- [GoReleaser Config](.goreleaser.yml)" >> $GITHUB_STEP_SUMMARY

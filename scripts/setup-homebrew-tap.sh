#!/bin/bash

# Script simplificado para configurar o repositÃ³rio homebrew-tap
# Execute: ./setup-homebrew-tap.sh

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ðŸº Aurora Boreas Homebrew Tap Setup (Simple)${NC}"
echo "=============================================="

# Verificar se git estÃ¡ instalado
if ! command -v git &> /dev/null; then
    echo -e "${RED}âŒ Git nÃ£o estÃ¡ instalado${NC}"
    exit 1
fi

# Verificar se o token estÃ¡ configurado
if [ -z "$USER_TOKEN" ]; then
    echo -e "${YELLOW}âš ï¸  VariÃ¡vel USER_TOKEN nÃ£o encontrada${NC}"
    echo -e "${BLUE}ðŸ’¡ Configure com: export USER_TOKEN=seu_token_github${NC}"
    echo -e "${BLUE}   Ou crie um arquivo .env com: USER_TOKEN=seu_token${NC}"
    
    # Tentar carregar de .env se existir
    if [ -f ".env" ]; then
        echo -e "${BLUE}ðŸ“„ Carregando .env...${NC}"
        source .env
    fi
    
    if [ -z "$USER_TOKEN" ]; then
        echo -e "${RED}âŒ USER_TOKEN Ã© obrigatÃ³rio para fazer push${NC}"
        exit 1
    fi
fi

REPO_NAME="homebrew-tap"
USERNAME="nataliagranato"
EMAIL="nataliagranato@ufmg.br"
REPO_URL="https://$USER_TOKEN@github.com/$USERNAME/$REPO_NAME.git"

echo -e "${BLUE}ðŸ”§ Configurando Git...${NC}"
git config --global user.name "$USERNAME"
git config --global user.email "$EMAIL"
git config --global credential.helper store

echo -e "${BLUE}ðŸ‘¤ UsuÃ¡rio: $USERNAME${NC}"
echo -e "${BLUE}ðŸ“¦ RepositÃ³rio: $REPO_NAME${NC}"
echo -e "${BLUE}ðŸ”— URL: $REPO_URL${NC}"

# Remover diretÃ³rio local se existir
if [ -d "$REPO_NAME" ]; then
    echo -e "${YELLOW}ðŸ“ Removendo diretÃ³rio local existente...${NC}"
    rm -rf "$REPO_NAME"
fi

# Clonar o repositÃ³rio
echo -e "${BLUE}ðŸ“¥ Clonando repositÃ³rio...${NC}"
if git clone "$REPO_URL" 2>/dev/null; then
    echo -e "${GREEN}âœ“ RepositÃ³rio clonado com sucesso!${NC}"
    cd "$REPO_NAME"
else
    echo -e "${RED}âŒ Falha ao clonar o repositÃ³rio${NC}"
    echo -e "${YELLOW}ðŸ“‹ Verifique se o repositÃ³rio existe em: https://github.com/$USERNAME/$REPO_NAME${NC}"
    echo -e "${BLUE}ðŸ’¡ Se nÃ£o existir, crie manualmente em: https://github.com/new${NC}"
    echo "   - Repository name: $REPO_NAME"
    echo "   - Description: Homebrew tap for Aurora Boreas"
    echo "   - âœ“ Public"
    echo "   - âœ— Add a README file"
    exit 1
fi

# Verificar estrutura atual
echo -e "${BLUE}ðŸ“‹ Verificando estrutura atual...${NC}"
if [ -f "Formula/auroraboreas.rb" ]; then
    echo -e "${GREEN}âœ“ FÃ³rmula auroraboreas.rb jÃ¡ existe${NC}"
else
    echo -e "${YELLOW}ðŸ“¦ Criando estrutura da fÃ³rmula...${NC}"
fi

# Criar estrutura de diretÃ³rios
echo -e "${YELLOW}ðŸ“ Garantindo estrutura de diretÃ³rios...${NC}"
mkdir -p Formula

# Atualizar README se necessÃ¡rio
if [ -f "../homebrew-tap-README.md" ]; then
    echo -e "${YELLOW}ðŸ“ Atualizando README.md...${NC}"
    cp ../homebrew-tap-README.md README.md
else
    echo -e "${YELLOW}âš ï¸  Arquivo homebrew-tap-README.md nÃ£o encontrado${NC}"
fi

# Criar/atualizar fÃ³rmula inicial (serÃ¡ substituÃ­da pelo GoReleaser)
echo -e "${YELLOW}ðŸº Criando/atualizando fÃ³rmula inicial...${NC}"
cat > Formula/auroraboreas.rb << 'EOF'
# This file is auto-generated by GoReleaser
# Do not edit manually
class Auroraboreas < Formula
  desc "Aurora Boreas - Poesia e visualizaÃ§Ã£o de cÃ©u estrelado"
  homepage "https://github.com/nataliagranato/auroraboreas"
  version "0.1.0"
  
  # This will be updated by GoReleaser
  url "https://github.com/nataliagranato/auroraboreas/releases/download/v0.1.0/auroraboreas-v0.1.0-darwin-amd64.tar.gz"
  sha256 "placeholder"
  
  def install
    bin.install "aurora"
  end

  test do
    system "#{bin}/aurora", "--version"
  end
end
EOF

# Criar .gitignore se nÃ£o existir
if [ ! -f ".gitignore" ]; then
    echo -e "${YELLOW}ðŸ“„ Criando .gitignore...${NC}"
    cat > .gitignore << 'EOF'
.DS_Store
*.swp
*.swo
*~
EOF
else
    echo -e "${GREEN}âœ“ .gitignore jÃ¡ existe${NC}"
fi

# Verificar se hÃ¡ mudanÃ§as para commitar
echo -e "${BLUE}ðŸ” Verificando mudanÃ§as...${NC}"
git add .

if git diff --staged --quiet; then
    echo -e "${GREEN}âœ“ Nenhuma mudanÃ§a para commitar${NC}"
    
    # Voltar ao diretÃ³rio principal
    cd ..
    
    # Limpar diretÃ³rio temporÃ¡rio se nÃ£o houve mudanÃ§as
    echo -e "${YELLOW}ðŸ§¹ Limpando diretÃ³rio temporÃ¡rio...${NC}"
    rm -rf homebrew-tap
    
    PUSH_SUCCESS=true
else
    # Commit das mudanÃ§as
    echo -e "${YELLOW}ðŸ“¤ Commitando mudanÃ§as...${NC}"
    git commit -m "Update Aurora Boreas Homebrew tap

- Update Formula structure
- Update README with latest information
- Ensure all required files are present
- Formula will be auto-updated by GoReleaser on releases"
    
    # Push para o GitHub
    echo -e "${YELLOW}ðŸ“¤ Fazendo push para GitHub...${NC}"
    echo -e "${BLUE}ðŸ’¡ Se houver erro de autenticaÃ§Ã£o, configure suas credenciais do GitHub${NC}"
    
    if git push origin main; then
        echo -e "${GREEN}âœ… Push realizado com sucesso!${NC}"
        
        # Voltar ao diretÃ³rio principal
        cd ..
        
        # Limpar diretÃ³rio temporÃ¡rio apenas se o push foi bem-sucedido
        echo -e "${YELLOW}ðŸ§¹ Limpando diretÃ³rio temporÃ¡rio...${NC}"
        rm -rf homebrew-tap
        
        PUSH_SUCCESS=true
    else
        echo -e "${RED}âŒ Erro no push${NC}"
        echo -e "${YELLOW}ðŸ”§ SoluÃ§Ãµes possÃ­veis:${NC}"
        echo "1. Verifique se USER_TOKEN estÃ¡ correto e tem permissÃµes de escrita"
        echo "2. Gere um novo token em: https://github.com/settings/tokens"
        echo "3. Configure: export USER_TOKEN=seu_novo_token"
        echo "4. Ou use SSH: git remote set-url origin git@github.com:$USERNAME/$REPO_NAME.git"
        echo ""
        echo -e "${BLUE}ðŸ“‹ As mudanÃ§as foram commitadas localmente em: $(pwd)${NC}"
        echo -e "${BLUE}   VocÃª pode fazer push manual: cd homebrew-tap && git push origin main${NC}"
        
        # Voltar ao diretÃ³rio principal mas manter o diretÃ³rio homebrew-tap
        cd ..
        
        PUSH_SUCCESS=false
    fi
fi

echo ""
if [ "$PUSH_SUCCESS" = true ]; then
    echo -e "${GREEN}âœ… Setup do Homebrew Tap concluÃ­do com sucesso!${NC}"
else
    echo -e "${YELLOW}âš ï¸  Setup do Homebrew Tap concluÃ­do (push pendente)${NC}"
    echo -e "${BLUE}ðŸ“ DiretÃ³rio mantido em: ./homebrew-tap${NC}"
    echo -e "${BLUE}   Execute: cd homebrew-tap && git push origin main${NC}"
fi

echo
echo -e "${BLUE}ðŸ”— URLs importantes:${NC}"
echo -e "   RepositÃ³rio: ${GREEN}https://github.com/$USERNAME/$REPO_NAME${NC}"
echo -e "   FÃ³rmula: ${GREEN}https://github.com/$USERNAME/$REPO_NAME/blob/main/Formula/auroraboreas.rb${NC}"
echo
echo -e "${BLUE}ðŸ“ PrÃ³ximos passos:${NC}"
echo "1. FaÃ§a uma release no repositÃ³rio principal (git tag v0.2.0 && git push --tags)"
echo "2. O GoReleaser atualizarÃ¡ automaticamente a fÃ³rmula"
echo "3. Teste a instalaÃ§Ã£o: brew tap $USERNAME/tap && brew install auroraboreas"
echo
echo -e "${BLUE}ðŸº Para instalar via Homebrew (apÃ³s a primeira release):${NC}"
echo "   brew tap $USERNAME/tap"
echo "   brew install auroraboreas"
echo
echo -e "${GREEN}ðŸŽ‰ Setup concluÃ­do!${NC}"

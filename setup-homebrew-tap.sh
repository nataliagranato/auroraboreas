#!/bin/bash

# Script para criar e configurar o repositÃ³rio homebrew-tap
# Execute: ./setup-homebrew-tap.sh

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}ðŸº Aurora Boreas Homebrew Tap Setup${NC}"
echo "======================================"

# Verificar se gh CLI estÃ¡ instalado
if ! command -v gh &> /dev/null; then
    echo -e "${RED}âŒ GitHub CLI nÃ£o estÃ¡ instalado${NC}"
    echo "Instale com: brew install gh"
    exit 1
fi

# Verificar autenticaÃ§Ã£o
if ! gh auth status &> /dev/null; then
    echo -e "${YELLOW}âš ï¸  VocÃª nÃ£o estÃ¡ autenticado no GitHub${NC}"
    echo "Execute: gh auth login"
    exit 1
fi

REPO_NAME="homebrew-tap"
USERNAME="nataliagranato"

echo -e "${BLUE}ðŸ‘¤ UsuÃ¡rio: $USERNAME${NC}"
echo -e "${BLUE}ðŸ“¦ RepositÃ³rio: $REPO_NAME${NC}"

# Verificar se o repositÃ³rio jÃ¡ existe
if gh repo view "$USERNAME/$REPO_NAME" &> /dev/null; then
    echo -e "${GREEN}âœ“ RepositÃ³rio jÃ¡ existe!${NC}"
    if [ -d "$REPO_NAME" ]; then
        echo -e "${YELLOW}ðŸ“ Removendo diretÃ³rio local existente...${NC}"
        rm -rf "$REPO_NAME"
    fi
    echo -e "${BLUE}ðŸ“¥ Clonando repositÃ³rio...${NC}"
    gh repo clone "$USERNAME/$REPO_NAME"
    cd "$REPO_NAME"
else
    echo -e "${BLUE}ðŸ” RepositÃ³rio nÃ£o encontrado. Tentando criar...${NC}"
    
    # Primeiro, tentar via REST API diretamente
    echo -e "${YELLOW}ðŸ”§ Tentativa 1: Criando via GitHub CLI...${NC}"
    if gh repo create "$USERNAME/$REPO_NAME" --public --description "Homebrew tap for Aurora Boreas" 2>/dev/null; then
        echo -e "${GREEN}âœ“ RepositÃ³rio criado com sucesso!${NC}"
        gh repo clone "$USERNAME/$REPO_NAME"
        cd "$REPO_NAME"
    else
        echo -e "${YELLOW}âš ï¸  Falha na criaÃ§Ã£o automÃ¡tica${NC}"
        echo -e "${BLUE}ðŸ› ï¸  Configurando para criaÃ§Ã£o manual...${NC}"
        
        # Criar diretÃ³rio local
        mkdir -p "$REPO_NAME"
        cd "$REPO_NAME"
        git init -b main
        
        echo ""
        echo -e "${YELLOW}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
        echo -e "${YELLOW}â”‚          CRIAÃ‡ÃƒO MANUAL NECESSÃRIA          â”‚${NC}"
        echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
        echo ""
        echo -e "${BLUE}ï¿½ Passos para criar o repositÃ³rio:${NC}"
        echo ""
        echo "1. Abra: https://github.com/new"
        echo "2. Repository name: $REPO_NAME"
        echo "3. Description: Homebrew tap for Aurora Boreas"
        echo "4. âœ“ Public"
        echo "5. âœ— Add a README file"
        echo "6. âœ— Add .gitignore"
        echo "7. âœ— Choose a license"
        echo "8. Click 'Create repository'"
        echo ""
        echo -e "${GREEN}Quando terminar, pressione Enter para continuar...${NC}"
        read -r
        
        # Configurar remote
        git remote add origin "https://github.com/$USERNAME/$REPO_NAME.git"
        
        # Verificar se foi criado
        echo -e "${BLUE}ðŸ” Verificando se o repositÃ³rio foi criado...${NC}"
        sleep 2
        if gh repo view "$USERNAME/$REPO_NAME" &> /dev/null; then
            echo -e "${GREEN}âœ“ RepositÃ³rio encontrado!${NC}"
        else
            echo -e "${RED}âŒ RepositÃ³rio nÃ£o encontrado. Verifique se foi criado corretamente.${NC}"
            exit 1
        fi
    fi
fi

# Criar estrutura de diretÃ³rios
echo -e "${YELLOW}ðŸ“ Criando estrutura de diretÃ³rios...${NC}"
mkdir -p Formula

# Criar README
echo -e "${YELLOW}ðŸ“ Criando README.md...${NC}"
cp ../homebrew-tap-README.md README.md

# Criar fÃ³rmula inicial (serÃ¡ substituÃ­da pelo GoReleaser)
echo -e "${YELLOW}ðŸº Criando fÃ³rmula inicial...${NC}"
cat > Formula/auroraboreas.rb << 'EOF'
# This file is auto-generated by GoReleaser
# Do not edit manually
class Auroraboreas < Formula
  desc "Aurora Boreas - Poesia e visualizaÃ§Ã£o de cÃ©u estrelado"
  homepage "https://github.com/nataliagranato/auroraboreas"
  version "0.1.0"
  
  # This will be updated by GoReleaser
  url "https://github.com/nataliagranato/auroraboreas/releases/download/v0.1.0/auroraboreas-v0.1.0-darwin-amd64.tar.gz"
  sha256 "placeholder"
  
  def install
    bin.install "aurora"
  end

  test do
    system "#{bin}/aurora", "--version"
  end
end
EOF

# Criar .gitignore
echo -e "${YELLOW}ðŸ“„ Criando .gitignore...${NC}"
cat > .gitignore << 'EOF'
.DS_Store
*.swp
*.swo
*~
EOF

# Commit inicial
echo -e "${YELLOW}ðŸ“¤ Fazendo commit inicial...${NC}"
git add .
git commit -m "Initial commit: Aurora Boreas Homebrew tap

- Add Formula directory structure
- Add initial auroraboreas formula (will be auto-updated)
- Add README with usage instructions"

# Push para o GitHub
git push origin main

echo -e "${GREEN}âœ… RepositÃ³rio homebrew-tap criado com sucesso!${NC}"
echo
echo -e "${BLUE}ðŸ”— URLs importantes:${NC}"
echo -e "   RepositÃ³rio: ${GREEN}https://github.com/$USERNAME/$REPO_NAME${NC}"
echo -e "   Clone URL: ${GREEN}git@github.com:$USERNAME/$REPO_NAME.git${NC}"
echo
echo -e "${BLUE}ðŸ“ PrÃ³ximos passos:${NC}"
echo "1. Certifique-se de que o GoReleaser estÃ¡ configurado para usar este tap"
echo "2. FaÃ§a uma release no repositÃ³rio principal para testar"
echo "3. Verifique se a fÃ³rmula Ã© atualizada automaticamente"
echo
echo -e "${BLUE}ðŸº Para instalar via Homebrew:${NC}"
echo "   brew tap $USERNAME/tap"
echo "   brew install auroraboreas"

cd ..
echo -e "${YELLOW}ðŸ§¹ Limpando diretÃ³rio temporÃ¡rio...${NC}"
rm -rf homebrew-tap

echo -e "${GREEN}ðŸŽ‰ Setup concluÃ­do!${NC}"
echo -e "${BLUE}ðŸ’¡ Nota: O diretÃ³rio homebrew-tap foi removido localmente.${NC}"
echo -e "${BLUE}   Use o repositÃ³rio separado: https://github.com/$USERNAME/$REPO_NAME${NC}"
